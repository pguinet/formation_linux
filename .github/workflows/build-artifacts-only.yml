name: ðŸ“¦ Build PDFs (Artifacts Only)

# Workflow de fallback qui gÃ©nÃ¨re seulement les artifacts sans crÃ©er de releases
# Utile si les permissions pour les releases posent problÃ¨me

on:
  workflow_dispatch:  # DÃ©clenchement manuel uniquement
    inputs:
      reason:
        description: 'Raison du build manuel'
        required: false
        default: 'Build de test'

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“ Build reason
      run: |
        echo "ðŸŽ¯ **Raison du build:** ${{ github.event.inputs.reason || 'Build manuel' }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **DÃ©clenchÃ© par:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      
    - name: ðŸ› ï¸ Install LaTeX and dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          pandoc \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-lang-french \
          ghostscript > /dev/null 2>&1
          
        echo "âœ… DÃ©pendances installÃ©es"
        
    - name: ðŸ“ Create build directories
      run: |
        mkdir -p build/modules_additionnels
        chmod +x scripts/*.sh
        
    - name: ðŸ”¨ Build Git module
      run: |
        echo "ðŸ”¨ Construction du module Git..."
        if ./scripts/build_git_module.sh > /dev/null 2>&1; then
          echo "âœ… Module Git: Success"
          echo "GIT_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âŒ Module Git: Failed"
          echo "GIT_SUCCESS=false" >> $GITHUB_ENV
        fi
        
    - name: ðŸ³ Build Docker module
      run: |
        echo "ðŸ³ Construction du module Docker..."
        if ./scripts/build_docker_module.sh > /dev/null 2>&1; then
          echo "âœ… Module Docker: Success"
          echo "DOCKER_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âŒ Module Docker: Failed"
          echo "DOCKER_SUCCESS=false" >> $GITHUB_ENV
        fi
        
    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸ“Š RÃ©sultats de Construction" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$GIT_SUCCESS" = "true" ] && [ -f "build/modules_additionnels/module_additionnel_git.pdf" ]; then
          size_git=$(du -h build/modules_additionnels/module_additionnel_git.pdf | cut -f1)
          echo "âœ… **Module Git:** $size_git" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Git:** Ã‰chec de gÃ©nÃ©ration" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$DOCKER_SUCCESS" = "true" ] && [ -f "build/modules_additionnels/module_additionnel_docker.pdf" ]; then
          size_docker=$(du -h build/modules_additionnels/module_additionnel_docker.pdf | cut -f1)
          echo "âœ… **Module Docker:** $size_docker" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Docker:** Ã‰chec de gÃ©nÃ©ration" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“¤ Upload All PDFs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: formation-pdfs-manual-${{ github.run_number }}
        path: build/**/*.pdf
        retention-days: 30
        if-no-files-found: warn
        
    - name: ðŸ“‹ Final Instructions
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ Comment rÃ©cupÃ©rer les PDFs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Faire dÃ©filer vers le bas de cette page" >> $GITHUB_STEP_SUMMARY
        echo "2. Dans la section **Artifacts**, cliquer sur \`formation-pdfs-manual-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Le fichier ZIP contient tous les PDFs gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Note:** Ce workflow ne crÃ©e pas de release, seulement des artifacts temporaires (30 jours)." >> $GITHUB_STEP_SUMMARY