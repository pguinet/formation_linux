name: ğŸ“š Build Formation PDFs

on:
  push:
    branches: [ master, main ]
    paths:
      - 'supports/**'
      - 'travaux_pratiques/**'
      - 'scripts/**'
      - '.github/workflows/build-pdfs.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'supports/**'
      - 'travaux_pratiques/**'
      - 'scripts/**'
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install LaTeX and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-lang-french \
          texlive-xetex \
          ghostscript
          
    - name: âœ… Verify installations
      run: |
        pandoc --version
        pdflatex --version
        gs --version
        echo "ğŸ“‹ Testing French support..."
        pdflatex -interaction=nonstopmode <<< '\documentclass{article}\usepackage[french]{babel}\usepackage[utf8]{inputenc}\begin{document}Test franÃ§ais: Ã© Ã  Ã§\end{document}' && echo "âœ… French support OK" || echo "âŒ French support failed"
        
    - name: ğŸ“ Create build directories
      run: |
        mkdir -p build/modules_additionnels
        chmod +x scripts/*.sh
        
    - name: ğŸ”¨ Build Git module PDF
      run: |
        echo "ğŸ”¨ Building Git module..."
        ./scripts/build_git_module.sh || echo "âš ï¸ Git module build failed"
        
    - name: ğŸ³ Build Docker module PDF
      run: |
        echo "ğŸ³ Building Docker module..."
        ./scripts/build_docker_module.sh || echo "âš ï¸ Docker module build failed"
        
    - name: ğŸ“š Build all additional modules
      run: |
        echo "ğŸ“š Building all additional modules..."
        ./scripts/build_modules_additionnels.sh || echo "âš ï¸ Some modules failed"
        
    - name: ğŸ“Š List generated files
      run: |
        echo "ğŸ“Š Generated PDFs:"
        find build/ -name "*.pdf" -exec ls -lh {} \; || echo "No PDFs found"
        
    - name: ğŸ“¤ Upload PDFs as artifacts
      uses: actions/upload-artifact@v4
      if: always()  # Upload mÃªme si certains builds ont Ã©chouÃ©
      with:
        name: formation-linux-pdfs-${{ github.sha }}
        path: |
          build/**/*.pdf
        retention-days: 90
        
    - name: ğŸ“¤ Upload Git module PDF
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: module-git-pdf
        path: build/modules_additionnels/module_additionnel_git.pdf
        retention-days: 90
        if-no-files-found: warn
        
    - name: ğŸ“¤ Upload Docker module PDF
      uses: actions/upload-artifact@v4  
      if: always()
      with:
        name: module-docker-pdf
        path: build/modules_additionnels/module_additionnel_docker.pdf
        retention-days: 90
        if-no-files-found: warn
        
    - name: ğŸ“‹ Build summary
      if: always()
      run: |
        echo "## ğŸ“š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/modules_additionnels/module_additionnel_git.pdf" ]; then
          size_git=$(du -h build/modules_additionnels/module_additionnel_git.pdf | cut -f1)
          echo "âœ… **Module Git** : $size_git" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Git** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "build/modules_additionnels/module_additionnel_docker.pdf" ]; then
          size_docker=$(du -h build/modules_additionnels/module_additionnel_docker.pdf | cut -f1)
          echo "âœ… **Module Docker** : $size_docker" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Docker** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¥ **Artifacts disponibles :**" >> $GITHUB_STEP_SUMMARY
        echo "- \`formation-linux-pdfs-${{ github.sha }}\` - Tous les PDFs" >> $GITHUB_STEP_SUMMARY
        echo "- \`module-git-pdf\` - Module Git uniquement" >> $GITHUB_STEP_SUMMARY  
        echo "- \`module-docker-pdf\` - Module Docker uniquement" >> $GITHUB_STEP_SUMMARY
        
  # Job optionnel pour crÃ©er une release automatique
  create-release:
    needs: build-pdfs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-pdf"
        path: ./pdfs
        
    - name: ğŸ“‹ List downloaded files
      run: |
        echo "ğŸ“‹ Downloaded PDFs:"
        find ./pdfs -name "*.pdf" -exec ls -lh {} \;
        
    - name: ğŸ·ï¸ Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: "Formation Linux - Build ${{ github.run_number }}"
        body: |
          ## ğŸ“š Formation Linux - PDFs automatiques
          
          **Commit:** `${{ github.sha }}`
          **Date:** ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“„ Modules disponibles :
          - **Module Git** : ContrÃ´le de version (6-8h)  
          - **Module Docker** : Conteneurisation (12-15h)
          
          ### ğŸš€ Utilisation :
          1. TÃ©lÃ©charger les PDFs depuis les assets ci-dessous
          2. Consulter la [documentation](https://github.com/${{ github.repository }}) pour les prÃ©requis
          3. Suivre les modules dans l'ordre recommandÃ©
          
          ---
          ğŸ¤– Build automatique via GitHub Actions
        files: |
          ./pdfs/**/*.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}