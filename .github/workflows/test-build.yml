name: ğŸ§ª Test Formation PDFs

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - 'supports/**'
      - 'travaux_pratiques/**'
      - 'scripts/**'
      - '.github/workflows/test-build.yml'
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  test-build-pdfs:
    runs-on: ubuntu-latest
    permissions:
      actions: read    # Lire les actions
      packages: read   # Lire les packages

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Install LaTeX and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-lang-french \
          texlive-xetex \
          ghostscript

    - name: âœ… Verify installations
      run: |
        pandoc --version
        pdflatex --version
        gs --version
        echo "ğŸ“‹ Testing French support..."
        pdflatex -interaction=nonstopmode <<< '\documentclass{article}\usepackage[french]{babel}\usepackage[utf8]{inputenc}\begin{document}Test franÃ§ais: Ã© Ã  Ã§\end{document}' && echo "âœ… French support OK" || echo "âŒ French support failed"

    - name: ğŸ“ Create build directories
      run: |
        mkdir -p build/formations
        mkdir -p build/modules_base
        mkdir -p build/modules_additionnels
        chmod +x scripts/*.sh

    - name: ğŸ“š Test PDF generation
      run: |
        echo "ğŸ§ª Testing PDF generation according to specifications..."
        ./scripts/build_formations.sh

    - name: ğŸ“Š Validate generated files
      run: |
        echo "ğŸ“Š Validation des PDFs gÃ©nÃ©rÃ©s:"
        find build/ -name "*.pdf" -exec ls -lh {} \; || echo "âŒ No PDFs found"

        # VÃ©rifications de base
        if [ -f "build/formations/formation_acceleree.pdf" ]; then
          echo "âœ… Formation accÃ©lÃ©rÃ©e gÃ©nÃ©rÃ©e"
        else
          echo "âŒ Formation accÃ©lÃ©rÃ©e manquante"
          exit 1
        fi

        if [ -f "build/formations/formation_longue.pdf" ]; then
          echo "âœ… Formation longue gÃ©nÃ©rÃ©e"
        else
          echo "âŒ Formation longue manquante"
          exit 1
        fi

        # VÃ©rifier les modules de base (au moins quelques-uns)
        modules_count=$(find build/modules_base/ -name "*.pdf" 2>/dev/null | wc -l || echo "0")
        if [ "$modules_count" -gt 0 ]; then
          echo "âœ… $modules_count modules de base gÃ©nÃ©rÃ©s"
        else
          echo "âŒ Aucun module de base gÃ©nÃ©rÃ©"
          exit 1
        fi

        echo "ğŸ‰ Toutes les validations passÃ©es!"

    - name: ğŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-formation-linux-pdfs-${{ github.sha }}
        path: |
          build/**/*.pdf
        retention-days: 7  # Conservation courte pour les tests

    - name: ğŸ“‹ Test Summary
      if: always()
      run: |
        echo "## ğŸ§ª Test Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Formation accÃ©lÃ©rÃ©e
        if [ -f "build/formations/formation_acceleree.pdf" ]; then
          size_acceleree=$(du -h build/formations/formation_acceleree.pdf | cut -f1)
          echo "âœ… **Formation accÃ©lÃ©rÃ©e** : $size_acceleree" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Formation accÃ©lÃ©rÃ©e** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi

        # Formation longue
        if [ -f "build/formations/formation_longue.pdf" ]; then
          size_longue=$(du -h build/formations/formation_longue.pdf | cut -f1)
          echo "âœ… **Formation longue** : $size_longue" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Formation longue** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi

        # Modules de base individuels
        modules_count=$(find build/modules_base/ -name "*.pdf" 2>/dev/null | wc -l || echo "0")
        if [ "$modules_count" -gt 0 ]; then
          echo "âœ… **Modules de base individuels** : $modules_count modules gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Modules de base individuels** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi

        # Modules additionnels
        if [ -f "build/modules_additionnels/module_additionnel_git.pdf" ]; then
          size_git=$(du -h build/modules_additionnels/module_additionnel_git.pdf | cut -f1)
          echo "âœ… **Module Git** : $size_git" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Git** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "build/modules_additionnels/module_additionnel_docker.pdf" ]; then
          size_docker=$(du -h build/modules_additionnels/module_additionnel_docker.pdf | cut -f1)
          echo "âœ… **Module Docker** : $size_docker" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Module Docker** : Failed to build" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Informations du test" >> $GITHUB_STEP_SUMMARY
        echo "- **Type :** Test (sans release)" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger :** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branche :** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit :** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ Artifacts de test" >> $GITHUB_STEP_SUMMARY
        echo "Les PDFs de test sont disponibles dans l'artifact \`test-formation-linux-pdfs-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "Conservation : 7 jours" >> $GITHUB_STEP_SUMMARY